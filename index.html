<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magazia App - Image Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #eceff1; }
        .screen { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        input, .file-input { display: block; margin: 15px auto; padding: 12px; width: 90%; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 12px 25px; cursor: pointer; margin: 8px; border: none; border-radius: 8px; font-weight: bold; width: 100%; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #e74c3c; color: white; margin-top: 15px; }
        #reader { width: 100%; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        #product-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; margin: 10px auto; display: none; }
        .hidden { display: none; }
        #barcode-img { margin: 20px 0; max-width: 100%; }
    </style>
</head>
<body>

    <div class="screen">
        <h2>áƒ›áƒáƒ¦áƒáƒ–áƒ˜áƒ˜áƒ¡ áƒáƒáƒœáƒ”áƒšáƒ˜</h2>
        
        <div id="add-section">
            <input type="text" id="pName" placeholder="áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
            <input type="number" id="pPrice" placeholder="áƒ¤áƒáƒ¡áƒ˜ (â‚¾)">
            <input type="file" id="pImage" accept="image/*" class="file-input" onchange="processImage()">
            <img id="product-preview" src="">
            <button class="btn-blue" onclick="generateAndSave()">áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ áƒ“áƒ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        </div>

        <div id="result-section" class="hidden">
            <hr>
            <h3 id="display-name"></h3>
            <p id="display-price"></p>
            <img id="saved-product-img" src="" style="width:150px; border-radius:8px;">
            <br>
            <svg id="barcode-img"></svg>
            <button class="btn-green" onclick="showScanner()">áƒ¡áƒ™áƒáƒœáƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ áƒ—áƒ•áƒ</button>
            <button class="btn-red" onclick="clearData()">áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ</button>
        </div>

        <div id="scanner-section" class="hidden">
            <div id="reader"></div>
            <div id="scan-result" style="margin-top: 15px; font-weight: bold;"></div>
            <div id="payment-btns" class="hidden">
                <button class="btn-blue" onclick="fakePay('card')">ğŸ’³ Pay with Card</button>
                <button class="btn-green" onclick="fakePay('cash')">ğŸ’µ Pay with Cash</button>
            </div>
        </div>
    </div>

    <script>
        let myProduct = { name: "", price: "", code: "", image: "" };

        window.onload = function() {
            const savedData = localStorage.getItem('mySavedProduct');
            if (savedData) {
                myProduct = JSON.parse(savedData);
                displaySavedProduct();
            }
        };

        // áƒ¤áƒáƒ¢áƒáƒ¡ áƒ“áƒáƒ›áƒ£áƒ¨áƒáƒ•áƒ”áƒ‘áƒ áƒ“áƒ áƒ“áƒáƒáƒáƒ¢áƒáƒ áƒáƒ•áƒ”áƒ‘áƒ
        function processImage() {
            const file = document.getElementById('pImage').files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; // áƒ›áƒáƒ¥áƒ¡áƒ˜áƒ›áƒáƒšáƒ£áƒ áƒ˜ áƒ¡áƒ˜áƒ’áƒáƒœáƒ”
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // áƒ•áƒ˜áƒœáƒáƒ®áƒáƒ•áƒ— áƒ“áƒáƒáƒáƒ¢áƒáƒ áƒáƒ•áƒ”áƒ‘áƒ£áƒš áƒ¤áƒáƒ¢áƒáƒ¡
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); // 70% áƒ®áƒáƒ áƒ˜áƒ¡áƒ®áƒ˜
                    myProduct.image = dataUrl;
                    
                    document.getElementById('product-preview').src = dataUrl;
                    document.getElementById('product-preview').style.display = 'block';
                };
                img.src = e.target.result;
            };
            if (file) { reader.readAsDataURL(file); }
        }

        function generateAndSave() {
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;

            if (!name || !price || !myProduct.image) {
                alert("áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒ§áƒ•áƒ”áƒšáƒ áƒ•áƒ”áƒšáƒ˜!");
                return;
            }

            myProduct.name = name;
            myProduct.price = price;
            myProduct.code = "PROD-" + Math.floor(100000 + Math.random() * 900000);

            try {
                localStorage.setItem('mySavedProduct', JSON.stringify(myProduct));
                displaySavedProduct();
            } catch (e) {
                alert("áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ˜áƒ¡áƒáƒ¡. áƒ¡áƒªáƒáƒ“áƒ”áƒ— áƒ¡áƒ®áƒ•áƒ áƒ¤áƒáƒ¢áƒ.");
            }
        }

        function displaySavedProduct() {
            document.getElementById('add-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('display-name').innerText = "áƒœáƒ˜áƒ•áƒ—áƒ˜: " + myProduct.name;
            document.getElementById('display-price').innerText = "áƒ¤áƒáƒ¡áƒ˜: " + myProduct.price + "â‚¾";
            document.getElementById('saved-product-img').src = myProduct.image;
            JsBarcode("#barcode-img", myProduct.code, { format: "CODE128", displayValue: true });
        }

        function clearData() {
            localStorage.removeItem('mySavedProduct');
            location.reload();
        }

        function showScanner() {
            document.getElementById('scanner-section').classList.remove('hidden');
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                if (decodedText === myProduct.code) {
                    document.getElementById('scan-result').innerHTML = `<span style="color:green">áƒ¡áƒ™áƒáƒœáƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ: ${myProduct.name}</span>`;
                    document.getElementById('payment-btns').classList.remove('hidden');
                    html5QrCode.stop();
                } else {
                    alert("áƒ”áƒ¡ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ—áƒ•áƒ˜áƒ¡ áƒáƒ  áƒáƒ áƒ˜áƒ¡!");
                }
            }).catch(err => console.error(err));
        }

        function fakePay(type) {
            if (type === 'card') {
                alert("áƒ“áƒáƒáƒ“áƒ”áƒ— áƒ‘áƒáƒ áƒáƒ—áƒ˜ áƒ™áƒáƒ›áƒ”áƒ áƒáƒ¡!");
                setTimeout(() => alert("áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜áƒ! âœ…"), 2000);
            } else {
                alert("áƒ›áƒ˜áƒ˜áƒ¦áƒ”áƒ— áƒœáƒáƒ¦áƒ“áƒ˜ áƒ¤áƒ£áƒšáƒ˜: " + myProduct.price + "â‚¾");
            }
        }
    </script>
</body>
</html>
