<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magazia App - Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; background: #f0f2f5; }
        .screen { background: white; padding: 20px; border-radius: 15px; max-width: 380px; margin: 20px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { display: block; width: 90%; margin: 10px auto; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { width: 95%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .hidden { display: none; }
        #scanned-img { width: 100%; max-height: 200px; object-fit: contain; border-radius: 10px; }
        /* შავი გადახდის ეკრანი */
        .card-pay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; color: white; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="screen">
    <h2>მაღაზიის პანელი</h2>

    <div id="setup">
        <input type="text" id="name" placeholder="პროდუქტის სახელი">
        <input type="number" id="price" placeholder="ფასი">
        <input type="file" id="file" accept="image/*" onchange="handleImg()">
        <button class="btn-blue" onclick="save()">დამატება და შენახვა</button>
    </div>

    <div id="barcode-display" class="hidden">
        <h3 id="h-name"></h3>
        <svg id="barcode"></svg>
        <button class="btn-green" onclick="startScan()">სკანირება</button>
        <button onclick="localStorage.clear(); location.reload();">წაშლა</button>
    </div>

    <div id="scanner-ui" class="hidden">
        <div id="reader" style="width: 100%;"></div>
        <button class="btn-red" onclick="location.reload()">გაუქმება</button>
    </div>

    <div id="info-ui" class="hidden">
        <img id="scanned-img" src="">
        <h2 id="i-name"></h2>
        <h3 id="i-price" style="color: green;"></h3>
        <button class="btn-blue" onclick="openCardPay()">Pay with Card</button>
        <button class="btn-green" onclick="payCash()">Pay with Cash</button>
    </div>
</div>

<div id="card-modal" class="card-pay-screen hidden">
    <h1>დაადეთ ბარათი</h1>
    <p>გადაუღეთ ფოტო ბარათს გადასახდელად</p>
    <div id="card-cam" style="width: 300px;"></div>
    <button class="btn-red" onclick="location.reload()" style="width: 200px;">გაუქმება</button>
</div>

<script>
    let prod = { name: "", price: "", code: "", img: "" };

    window.onload = () => {
        let s = localStorage.getItem('prod');
        if(s) { prod = JSON.parse(s); showBarcode(); }
    };

    function handleImg() {
        let f = document.getElementById('file').files[0];
        let r = new FileReader();
        r.onload = (e) => {
            let i = new Image();
            i.onload = () => {
                let c = document.createElement('canvas');
                c.width = 400; c.height = i.height * (400/i.width);
                c.getContext('2d').drawImage(i, 0, 0, c.width, c.height);
                prod.img = c.toDataURL('image/jpeg', 0.6);
            };
            i.src = e.target.result;
        };
        r.readAsDataURL(f);
    }

    function save() {
        prod.name = document.getElementById('name').value;
        prod.price = document.getElementById('price').value;
        if(!prod.name || !prod.price || !prod.img) return alert("შეავსეთ ყველაფერი!");
        prod.code = "ID" + Math.floor(Math.random()*99999);
        localStorage.setItem('prod', JSON.stringify(prod));
        showBarcode();
    }

    function showBarcode() {
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('barcode-display').classList.remove('hidden');
        document.getElementById('h-name').innerText = prod.name;
        JsBarcode("#barcode", prod.code);
    }

    function startScan() {
        document.getElementById('barcode-display').classList.add('hidden');
        document.getElementById('scanner-ui').classList.remove('hidden');
        let scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => {
            if(t === prod.code) {
                scanner.stop().then(() => {
                    document.getElementById('scanner-ui').classList.add('hidden');
                    document.getElementById('info-ui').classList.remove('hidden');
                    document.getElementById('i-name').innerText = prod.name;
                    document.getElementById('i-price').innerText = prod.price + "₾";
                    document.getElementById('scanned-img').src = prod.img;
                });
            } else { alert("ეს თქვენთვის არ არის!"); }
        });
    }

    function openCardPay() {
        document.getElementById('card-modal').classList.remove('hidden');
        let cam = new Html5Qrcode("card-cam");
        cam.start({ facingMode: "environment" }, { fps: 10 }, () => {});
        setTimeout(() => {
            cam.stop();
            document.getElementById('card-modal').innerHTML = "<h1>გადახდილია! ✅</h1><button class='btn-green' onclick='location.reload()'>დასრულება</button>";
        }, 4000);
    }

    function payCash() {
        alert("ნაღდი ფული მიღებულია: " + prod.price + "₾");
        location.reload();
    }
</script>

</body>
</html>
