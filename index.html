<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magazia App - Final</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #eceff1; margin: 0; }
        .screen { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: 20px auto; }
        input, .file-input { display: block; margin: 15px auto; padding: 12px; width: 90%; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 12px 25px; cursor: pointer; margin: 8px auto; border: none; border-radius: 8px; font-weight: bold; width: 95%; display: block; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #product-preview, #scanned-item-img { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; margin: 10px auto; display: none; }
        .hidden { display: none; }
        .payment-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>

    <div class="screen">
        <h2>áƒ›áƒáƒ¦áƒáƒ–áƒ˜áƒ˜áƒ¡ áƒáƒáƒœáƒ”áƒšáƒ˜</h2>
        
        <div id="add-section">
            <input type="text" id="pName" placeholder="áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">
            <input type="number" id="pPrice" placeholder="áƒ¤áƒáƒ¡áƒ˜ (â‚¾)">
            <input type="file" id="pImage" accept="image/*" onchange="processImage()">
            <img id="product-preview" src="">
            <button class="btn-blue" onclick="generateAndSave()">áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ áƒ“áƒ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
        </div>

        <div id="result-section" class="hidden">
            <h3 id="display-name"></h3>
            <p id="display-price"></p>
            <svg id="barcode-img"></svg>
            <button class="btn-green" onclick="openScanner()">ğŸ” áƒ¡áƒ™áƒáƒœáƒ˜áƒ áƒ”áƒ‘áƒ</button>
            <button class="btn-red" onclick="clearData()">áƒ¬áƒáƒ¨áƒšáƒ</button>
        </div>

        <div id="info-section" class="hidden">
            <div style="border: 2px solid #27ae60; padding: 15px; border-radius: 10px;">
                <img id="scanned-item-img" src="" style="display: block;">
                <h2 id="info-name"></h2>
                <h3 id="info-price" style="color: #27ae60;"></h3>
                <hr>
                <button class="btn-blue" onclick="startCardPayment()">ğŸ’³ Pay with Card</button>
                <button class="btn-green" onclick="payWithCash()">ğŸ’µ Pay with Cash</button>
                <button onclick="location.reload()">áƒ£áƒ™áƒáƒœ</button>
            </div>
        </div>

        <div id="scanner-container" class="hidden">
            <div id="reader"></div>
            <button class="btn-red" onclick="location.reload()">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
        </div>
    </div>

    <div id="card-modal" class="payment-modal hidden">
        <h2>áƒ“áƒáƒáƒ“áƒ”áƒ— áƒ‘áƒáƒ áƒáƒ—áƒ˜</h2>
        <p>áƒ’áƒáƒ“áƒáƒ£áƒ¦áƒ”áƒ— áƒ¤áƒáƒ¢áƒ áƒ‘áƒáƒ áƒáƒ—áƒ¡ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒ“áƒ”áƒšáƒáƒ“</p>
        <div id="card-reader" style="width: 300px;"></div>
        <button class="btn-red" onclick="location.reload()">áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ</button>
    </div>

    <script>
        let myProduct = { name: "", price: "", code: "", image: "" };

        window.onload = function() {
            const saved = localStorage.getItem('mySavedProduct');
            if (saved) {
                myProduct = JSON.parse(saved);
                showResultScreen();
            }
        };

        function processImage() {
            const file = document.getElementById('pImage').files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const scale = 400 / img.width;
                    canvas.width = 400;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    myProduct.image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('product-preview').src = myProduct.image;
                    document.getElementById('product-preview').style.display = 'block';
                };
                img.src = e.target.result;
            };
            if (file) reader.readAsDataURL(file);
        }

        function generateAndSave() {
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            if (!name || !price || !myProduct.image) return alert("áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒ§áƒ•áƒ”áƒšáƒáƒ¤áƒ”áƒ áƒ˜!");

            myProduct.name = name;
            myProduct.price = price;
            myProduct.code = "ID-" + Math.floor(Math.random() * 900000);
            localStorage.setItem('mySavedProduct', JSON.stringify(myProduct));
            showResultScreen();
        }

        function showResultScreen() {
            document.getElementById('add-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('display-name').innerText = myProduct.name;
            document.getElementById('display-price').innerText = myProduct.price + "â‚¾";
            JsBarcode("#barcode-img", myProduct.code);
        }

        function openScanner() {
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('scanner-container').classList.remove('hidden');
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                if (text === myProduct.code) {
                    scanner.stop();
                    showInfo();
                } else {
                    alert("áƒ”áƒ¡ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ—áƒ•áƒ˜áƒ¡ áƒáƒ  áƒáƒ áƒ˜áƒ¡!");
                }
            });
        }

        function showInfo() {
            document.getElementById('scanner-container').classList.add('hidden');
            document.getElementById('info-section').classList.remove('hidden');
            document.getElementById('info-name').innerText = myProduct.name;
            document.getElementById('info-price').innerText = "áƒ¤áƒáƒ¡áƒ˜: " + myProduct.price + "â‚¾";
            document.getElementById('scanned-item-img').src = myProduct.image;
        }

        function startCardPayment() {
            document.getElementById('card-modal').classList.remove('hidden');
            const cardScanner = new Html5Qrcode("card-reader");
            cardScanner.start({ facingMode: "environment" }, { fps: 10 }, () => {}); 
            
            setTimeout(() => {
                cardScanner.stop();
                document.getElementById('card-modal').innerHTML = "<h1>áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ˜áƒšáƒ˜áƒ! âœ…</h1><p>áƒ áƒ”áƒáƒšáƒ£áƒ áƒáƒ“ áƒ¤áƒ£áƒšáƒ˜ áƒáƒ  áƒ©áƒáƒ›áƒáƒ­áƒ áƒ˜áƒšáƒ</p><button onclick='location.reload()'>áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ</button>";
            }, 4000);
        }

        function payWithCash() {
            alert("áƒ›áƒ˜áƒ˜áƒ¦áƒ”áƒ— " + myProduct.price + "â‚¾ áƒœáƒáƒ¦áƒ“áƒ˜ áƒ¤áƒ£áƒšáƒ˜. áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ!");
            location.reload();
        }

        function clearData() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
